<!-- Copyright (c) 2026, Lassod -->
<!-- License: MIT -->

{% extends "templates/web.html" %}

{% block header %}
	<link rel="stylesheet" href="/assets/po/css/po_limiter.css">
{% endblock %}

{% block content %}
	<div class="po-limiter-container">
		<div class="page-head">
			<h1>PO Limiter Tool - Managing Director</h1>
			<p class="text-muted">Manage Purchase Order submission limits for users</p>
		</div>

		<!-- Pending Requests Section -->
		{% if pending_requests and pending_requests|length > 0 %}
		<div class="pending-requests-section">
			<div class="alert alert-info">
				<strong>{{ pending_requests|length }} Pending Request(s)</strong> - Review limit increase requests below
			</div>

			<div class="pending-requests-list">
				{% for request in pending_requests %}
				<div class="request-card" data-request-name="{{ request.name }}">
					<div class="request-header">
						<strong>{{ request.user }}</strong>
						<span class="text-muted">{{ request.company }}</span>
					</div>
					<div class="request-body">
						<p><strong>Requested Per PO Limit:</strong> {{ frappe.format_value(request.requested_per_po_limit, {'fieldtype': 'Currency'}) }}</p>
						<p><strong>Requested Per Month Limit:</strong> {{ frappe.format_value(request.requested_per_month_limit, {'fieldtype': 'Currency'}) }}</p>
						<p><strong>Reason:</strong> {{ request.reason }}</p>
						<p class="text-muted"><small>{{ frappe.format_value(request.creation, {'fieldtype': 'Datetime'}) }}</small></p>
					</div>
					<div class="request-actions">
						<button class="btn btn-success btn-sm btn-approve" data-request="{{ request.name }}">
							Approve
						</button>
						<button class="btn btn-danger btn-sm btn-reject" data-request="{{ request.name }}">
							Reject
						</button>
						<a href="#Form/PO Limit Increase Request/{{ request.name }}" class="btn btn-default btn-sm">
							View Details
						</a>
					</div>
				</div>
				{% endfor %}
			</div>
		</div>
		{% endif %}

		<!-- Tabs for different views -->
		<div class="po-limiter-tabs">
			<ul class="nav nav-tabs" role="tablist">
				<li role="presentation" class="active">
					<a href="#by-user" aria-controls="by-user" role="tab" data-toggle="tab">By User</a>
				</li>
				<li role="presentation">
					<a href="#all-limits" aria-controls="all-limits" role="tab" data-toggle="tab">All Limits</a>
				</li>
			</ul>

			<div class="tab-content">
				<!-- By User Tab -->
				<div role="tabpanel" class="tab-pane active" id="by-user">
					<div class="user-selection">
						<label>Select User:</label>
						<select id="user-select" class="form-control">
							<option value="">-- Select User --</option>
							{% for user in users %}
							<option value="{{ user.name }}">{{ user.full_name }} ({{ user.email }})</option>
							{% endfor %}
						</select>
					</div>

					<div class="company-selection" style="display:none;">
						<label>Select Company:</label>
						<select id="company-select" class="form-control">
							<option value="">-- Select Company --</option>
							{% for company in companies %}
							<option value="{{ company.name }}">{{ company.name }}</option>
							{% endfor %}
						</select>
					</div>

					<div id="limit-editor" style="display:none;">
						<div class="limit-form">
							<h3>Update PO Limits</h3>
							<div class="form-group">
								<label>Status:</label>
								<select id="limit-status" class="form-control">
									<option value="Active">Active</option>
									<option value="Revoked">Revoked</option>
								</select>
							</div>
							<div class="form-group">
								<label>Per PO Limit:</label>
								<input type="number" id="per-po-limit" class="form-control" min="0" step="0.01">
							</div>
							<div class="form-group">
								<label>Per Month Limit:</label>
								<input type="number" id="per-month-limit" class="form-control" min="0" step="0.01">
							</div>
							<div class="current-usage" id="current-usage" style="display:none;">
								<p class="text-info"><strong>Current Monthly Usage:</strong> <span id="monthly-usage"></span></p>
							</div>
							<button id="save-limit-btn" class="btn btn-primary">Save Limit</button>
							<button id="reset-limit-btn" class="btn btn-default">Reset</button>
						</div>
					</div>
				</div>

				<!-- All Limits Tab -->
				<div role="tabpanel" class="tab-pane" id="all-limits">
					<table class="table table-bordered">
						<thead>
							<tr>
								<th>User</th>
								<th>Company</th>
								<th>Status</th>
								<th>Per PO Limit</th>
								<th>Per Month Limit</th>
								<th>Monthly Usage</th>
								<th>Last Updated By</th>
								<th>Last Updated Date</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for limit in user_limits %}
							<tr>
								<td>{{ limit.user }}</td>
								<td>{{ limit.company }}</td>
								<td>
									<span class="label label-{% if limit.status == 'Active' %}success{% else %}warning{% endif %}">
										{{ limit.status }}
									</span>
								</td>
								<td>{{ frappe.format_value(limit.per_po_limit, {'fieldtype': 'Currency'}) }}</td>
								<td>{{ frappe.format_value(limit.per_month_limit, {'fieldtype': 'Currency'}) }}</td>
								<td>{{ frappe.format_value(limit.monthly_usage, {'fieldtype': 'Currency'}) }}</td>
								<td>{{ limit.last_updated_by or '-' }}</td>
								<td>{{ frappe.format_value(limit.last_updated_date, {'fieldtype': 'Datetime'}) or '-' }}</td>
								<td>
									<button class="btn btn-xs btn-default btn-edit-limit"
											data-user="{{ limit.user }}"
											data-company="{{ limit.company }}">
										Edit
									</button>
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block script %}
	<script type="text/javascript" src="/assets/po/js/po_limiter.js"></script>
{% endblock %}
